# Step2 ベースライン分析（人気・単勝オッズ）

> 方針メモ：本番運用では **`popularity`（人気）と `tansho_odds`（単勝オッズ）は学習に使わない**。  
> ここでは「市場（≒集合知）がどれくらい強いか」を **ベースライン**として数値化し、以後のモデルが超えるべき基準にする。

---

## 1. 主要サマリ

| 指標 | 値 |
|---|---:|
| fav_win_rate | 33.6% |
| fav_top3_rate | 65.1% |
| HitRate_win_in_top3_popularity | 66.5% |
| HitRate_win_in_top5_popularity | 82.7% |

- **1人気の1着率**：33.6%  
- **1人気の3着内率**：65.1%  
- **勝ち馬が人気上位3頭に含まれる率（HitRate@3）**：66.5%  
- **勝ち馬が人気上位5頭に含まれる率（HitRate@5）**：82.7%  

---

## 2. 人気順位ごとの成績（上位10まで）

| 人気 | 件数 | 1着率 | 3着内率 | 平均着順 | 中央着順 |
|---:|---:|---:|---:|---:|---:|
| 1 | 17,221 | 33.6% | 65.1% | 3.51 | 2 |
| 2 | 17,215 | 20.0% | 52.4% | 4.38 | 3 |
| 3 | 17,212 | 13.2% | 41.8% | 5.08 | 4 |
| 4 | 17,211 | 9.2% | 34.0% | 5.63 | 5 |
| 5 | 17,209 | 7.1% | 26.8% | 6.18 | 6 |
| 6 | 17,171 | 5.2% | 21.8% | 6.71 | 6 |
| 7 | 17,044 | 3.7% | 16.4% | 7.25 | 7 |
| 8 | 16,761 | 2.8% | 12.9% | 7.79 | 8 |
| 9 | 16,180 | 2.0% | 9.9% | 8.36 | 8 |
| 10 | 15,378 | 1.6% | 7.8% | 8.92 | 9 |

所感（読み取りのポイント）
- 人気が下がるほど、**勝率/3着内率が素直に低下**しており、市場の整合性は高そう。
- 以後の「人気・オッズ無しモデル」は、**この曲線をどれだけ近づける/部分的に超える**かが目標。

---

## 3. 人気上位K頭のカバー率

| K(人気上位) | 勝ち馬がTopKにいる率 | TopK内に3着内が1頭でもいる率 |
|---:|---:|---:|
| 1 | 33.5% | 64.9% |
| 2 | 53.4% | 85.1% |
| 3 | 66.5% | 93.2% |
| 4 | 75.6% | 96.9% |
| 5 | 82.7% | 98.6% |
| 6 | 87.8% | 99.4% |
| 8 | 94.2% | 99.9% |
| 10 | 97.5% | 100.0% |

所感
- Top3人気で勝ち馬を **約66.5%** カバー。Top5人気で **約82.7%**。  
- （研究用メモ）「荒れる」レースを識別できれば、**“Top5でも外すレース”**を事前に当てにいける。

---

## 4. 頭数（field size）別：1人気の信頼度

| 頭数帯(field_bin) | 1人気の件数 | 1着率 | 3着内率 | 平均着順 |
|---|---:|---:|---:|---:|
| <=10 | 2,939 | 40.9% | 75.6% | 2.57 |
| 11-14 | 5,801 | 34.2% | 65.3% | 3.37 |
| 15-18 | 8,481 | 30.7% | 61.4% | 3.93 |

所感
- **少頭数（<=10）では1人気1着率が高い**（40.9%）。  
- **多頭数（15–18）で低下**（30.7%）。  
- 以後の分析・モデルでは **`n_horses` を必ず特徴量に入れる**（レース難易度）。

---

## 5. 単勝オッズ帯別（参考：市場の強さ）

| 単勝オッズ帯 | 件数 | 1着率 | 3着内率 | 平均着順 |
|---|---:|---:|---:|---:|
| <=1.9 | 4,021 | 50.5% | 81.7% | 2.36 |
| 2-2.9 | 8,733 | 33.0% | 67.4% | 3.28 |
| 3-4.9 | 20,902 | 21.1% | 53.3% | 4.27 |
| 5-9.9 | 36,208 | 11.3% | 36.9% | 5.49 |
| 10-19.9 | 36,965 | 6.0% | 24.2% | 6.66 |
| 20-49.9 | 47,006 | 2.6% | 13.0% | 8.00 |
| 50-99.9 | 31,760 | 1.1% | 6.4% | 9.26 |
| 100+ | 50,243 | 0.3% | 2.1% | 11.06 |

所感
- オッズ帯が上がるほど勝率が落ちる **単調な関係**が確認できる（期待通り）。  
- 本番で使わなくても、「市場の強さ」や「荒れやすさ」を理解する指標として有用。

---

## 6. 条件別（1人気ベースライン）

### 6.1 race_type 別（コードは自分のエンコードに依存）
| race_type(コード) | 1人気の件数 | 1着率 | 3着内率 | 平均着順 |
|---:|---:|---:|---:|---:|
| 0 | 8,250 | 32.9% | 64.9% | 3.51 |
| 1 | 8,360 | 34.1% | 65.0% | 3.55 |
| 2 | 611 | 36.5% | 71.5% | 2.92 |

### 6.2 ground_state 別（コードは自分のエンコードに依存）
| ground_state(コード) | 1人気の件数 | 1着率 | 3着内率 | 平均着順 |
|---:|---:|---:|---:|---:|
| 3 | 603 | 32.7% | 61.4% | 3.70 |
| 2 | 1,446 | 33.1% | 62.2% | 3.72 |
| 1 | 2,912 | 33.6% | 65.2% | 3.52 |
| 0 | 12,260 | 33.7% | 65.7% | 3.47 |

### 6.3 距離帯別
| 距離帯(dist_bin) | 1人気の件数 | 1着率 | 3着内率 | 平均着順 |
|---|---:|---:|---:|---:|
| <=1400 | 6,116 | 32.2% | 62.7% | 3.75 |
| 1801-2200 | 2,607 | 33.8% | 66.1% | 3.38 |
| 1401-1800 | 7,184 | 34.3% | 66.2% | 3.42 |
| 2601+ | 640 | 35.6% | 71.2% | 2.96 |
| 2201-2600 | 664 | 36.9% | 66.7% | 3.31 |

所感（注意つき）
- race_type / ground_state は **大差は小さめ**に見える（ただしコードの意味の確認が必要）。
- 距離帯は **サンプル数が少ない帯（例：2601+）**があるので、ここは過信しない。  
  → 次Stepで **place×距離帯**まで切って「荒れる条件」を探すのが良い。

---

## 7. このStepの結論（3行で）

1. 市場は強く、**1人気は約33.6%で勝つ / 約65.1%で3着内**。  
2. **頭数が増えるほど1人気の信頼度が落ちる**ため、`n_horses`は必須特徴量。  
3. 本番は人気・オッズを使わないため、次は **市場を使わないベースライン（`hr_rank_mean_3`やレース内相対特徴）**でどこまで迫れるかを見る。