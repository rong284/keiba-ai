# EDA_03_Analysis_NoMarket.md

## 目的

- **市場情報（popularity / tansho_odds）なし**で、予測に効きそうな信号を探索する。

- このStepでは**モデル学習は行わず**、単変量・相対特徴・条件依存（交互作用の気配）を中心に“分析”として記録する。


## 前提

- 本番運用では `popularity` と `tansho_odds` は学習に使わない。

- 目的変数：

  - `y_win = (rank == 1)`

  - `y_top3 = (rank <= 3)`


## 使用した指標（学習なし）

- **AUC（単特徴）**：その特徴だけで勝ち/負けを順位付けできるか（0.5=無力、1.0=完璧）。

- **Spearman相関**：単調関係の強さ（符号は方向、絶対値が大きいほど単調）。


---

## 1. 単変量（絶対値）の結果：数値特徴 × {win/top3}

単変量（絶対値）では **`hr_rank_mean_3` が突出**。他の特徴はAUCが0.50〜0.56程度で弱い。


### y_win（上位）

| feature        |   non_null_rate |    spearman |      auc |
|:---------------|----------------:|------------:|---------:|
| hr_rank_mean_3 |        0.899825 | -0.19151    | 0.700327 |
| weight         |        1        |  0.052073   | 0.557638 |
| age            |        1        | -0.0380763  | 0.540251 |
| sex            |        1        | -0.0363131  | 0.535415 |
| impost         |        1        |  0.0198379  | 0.521649 |
| umaban         |        1        | -0.0128752  | 0.514223 |
| weight_diff    |        1        |  0.00898806 | 0.509856 |
| wakuban        |        1        |  0.00756252 | 0.508304 |


### y_top3（上位）

| feature        |   non_null_rate |    spearman |      auc |
|:---------------|----------------:|------------:|---------:|
| hr_rank_mean_3 |        0.899825 | -0.290414   | 0.691777 |
| weight         |        1        |  0.0638281  | 0.544476 |
| sex            |        1        | -0.0543085  | 0.533344 |
| age            |        1        | -0.0479825  | 0.531932 |
| impost         |        1        |  0.0436384  | 0.52998  |
| umaban         |        1        | -0.028776   | 0.520012 |
| weight_diff    |        1        |  0.0121684  | 0.5084   |
| wakuban        |        1        |  0.00921216 | 0.506368 |


**観察**

- 競馬は「絶対値」単体では当たりにくい（文脈/条件/相対で効くことが多い）。

- 以降、**レース内相対特徴**（平均との差・順位・偏差）に寄せる。


---

## 2. レース内相対特徴（平均との差・順位等）の結果

同じ特徴でも、レース内で相対化すると単変量でも信号が増える。特に `hr_rank_mean_3` 系は **AUCがさらに上振れ**。


### 相対特徴：y_win AUC 上位10

| feature                  |   non_null_rate |   spearman |      auc |
|:-------------------------|----------------:|-----------:|---------:|
| hr_rank_mean_3_rank_asc  |        0.899825 | -0.202022  | 0.710585 |
| hr_rank_mean_3_z         |        0.899825 | -0.199851  | 0.708278 |
| hr_rank_mean_3_diff_mean |        0.899825 | -0.199344  | 0.707751 |
| hr_rank_mean_3_pct_asc   |        0.899825 | -0.19645   | 0.70456  |
| hr_rank_mean_3_pct_desc  |        0.899825 |  0.19645   | 0.70456  |
| hr_rank_mean_3_rank_desc |        0.899825 |  0.157819  | 0.665288 |
| age_rank_asc             |        1        | -0.102469  | 0.61294  |
| age_pct_desc             |        1        |  0.0855937 | 0.588308 |
| age_pct_asc              |        1        | -0.0855937 | 0.588308 |
| age_diff_mean            |        1        | -0.0825594 | 0.58525  |


### 相対特徴：y_top3 AUC 上位10

| feature                  |   non_null_rate |   spearman |      auc |
|:-------------------------|----------------:|-----------:|---------:|
| hr_rank_mean_3_rank_asc  |        0.899825 |  -0.311979 | 0.705508 |
| hr_rank_mean_3_diff_mean |        0.899825 |  -0.30355  | 0.699719 |
| hr_rank_mean_3_z         |        0.899825 |  -0.301583 | 0.698685 |
| hr_rank_mean_3_pct_asc   |        0.899825 |  -0.295551 | 0.694498 |
| hr_rank_mean_3_pct_desc  |        0.899825 |   0.295551 | 0.694498 |
| hr_rank_mean_3_rank_desc |        0.899825 |   0.23649  | 0.656065 |
| age_rank_asc             |        1        |  -0.150307 | 0.604294 |
| n_horses                 |        1        |  -0.109543 | 0.574658 |
| age_pct_desc             |        1        |   0.107429 | 0.569775 |
| age_pct_asc              |        1        |  -0.107429 | 0.569775 |


**観察**

- `hr_rank_mean_3` を **レース内順位（rank_asc）** / **zスコア** / **平均との差** にしたものが上位を占める。

- 次点で `age` のレース内順位/偏差が効き始める（ただし主役ではない）。

- `n_horses`（頭数）は top3 で上位に現れ、**多頭数ほど不確実性が上がる**傾向の反映が出ている。


---

## 3. 条件系カラム（race_type / around / course_len / weather / ground_state / race_class）について

これらは単体の勝率差より、**他特徴の効き方を変える“条件”**として働きやすい。


**このStepでの扱い方（学習なし）**

- まずは `dist_bin`（距離帯）や `field_bin`（頭数帯）を作り、

  - 例：`dist_bin` ごとに `hr_rank_mean_3` の単特徴AUCを算出

  - 例：`ground_state` ごとに `hr_rank_mean_3_rank_asc` の単特徴AUCを算出

- **グループ別AUCのブレが大きいほど**、その条件が“効き方を変える”（交互作用がある）サインになる。


**メモ**

- `course_len` は数値としても使えるが、EDAでは `dist_bin` による分割が直感的でおすすめ。

- `race_class` はカテゴリとして入れると「格の違い」による難易度差が見えやすい。


---

## 4. 騎手/調教師/馬主IDの勝率（分析用）

ID系はサンプルが少ないと上振れしやすいため、**平滑化（s）**した勝率も併記して分析。


- 全体平均：win=7.338%, top3=21.993%


### jockey_id

**出走数が多い順（Top10）**

|   jockey_id |    n |   win_rate_s |   top3_rate_s |   win_rate |   top3_rate |
|------------:|-----:|-------------:|--------------:|-----------:|------------:|
|        1091 | 4328 |    0.0739124 |      0.259935 |  0.0739372 |    0.261784 |
|        1126 | 4226 |    0.13933   |      0.35133  |  0.142451  |    0.357549 |
|        1157 | 4216 |    0.0916384 |      0.279435 |  0.0925047 |    0.282258 |
|        1174 | 3997 |    0.11977   |      0.328803 |  0.122092  |    0.334251 |
|         732 | 3972 |    0.0694332 |      0.220754 |  0.0692346 |    0.220796 |
|        1179 | 3971 |    0.0850336 |      0.260366 |  0.0856208 |    0.262402 |
|        1170 | 3862 |    0.143692  |      0.370996 |  0.147333  |    0.378819 |
|        5386 | 3830 |    0.152773  |      0.382378 |  0.156919  |    0.390862 |
|        1018 | 3674 |    0.0543819 |      0.216826 |  0.0533478 |    0.216658 |
|        1163 | 3469 |    0.135643  |      0.34941  |  0.139233  |    0.356875 |


**平滑化win率が高い順（Top10）**

|   jockey_id |    n |   win_rate_s |   top3_rate_s |   win_rate |   top3_rate |
|------------:|-----:|-------------:|--------------:|-----------:|------------:|
|        1088 | 2507 |     0.255144 |      0.54377  |   0.269645 |    0.569605 |
|        5339 | 3143 |     0.240405 |      0.527964 |   0.251034 |    0.547566 |
|        5509 |  410 |     0.209304 |      0.46555  |   0.27561  |    0.585366 |
|        5473 |  519 |     0.183137 |      0.421398 |   0.225434 |    0.499037 |
|        5585 |  477 |     0.179727 |      0.412091 |   0.224319 |    0.492662 |
|        1014 | 1399 |     0.160522 |      0.405244 |   0.172981 |    0.431737 |
|        5386 | 3830 |     0.152773 |      0.382378 |   0.156919 |    0.390862 |
|        1046 |  219 |     0.14481  |      0.319774 |   0.210046 |    0.410959 |
|        1170 | 3862 |     0.143692 |      0.370996 |   0.147333 |    0.378819 |
|        1126 | 4226 |     0.13933  |      0.35133  |   0.142451 |    0.357549 |

### trainer_id

**出走数が多い順（Top10）**

|   trainer_id |    n |   win_rate_s |   top3_rate_s |   win_rate |   top3_rate |
|-------------:|-----:|-------------:|--------------:|-----------:|------------:|
|         1075 | 2506 |    0.102245  |      0.269026 |  0.104549  |    0.272945 |
|         1110 | 2348 |    0.08386   |      0.254311 |  0.084753  |    0.25724  |
|         1086 | 1928 |    0.0933625 |      0.259392 |  0.0954357 |    0.263485 |
|         1157 | 1877 |    0.128876  |      0.326907 |  0.13479   |    0.338306 |
|         1158 | 1701 |    0.0839954 |      0.244074 |  0.085244  |    0.246914 |
|         1039 | 1695 |    0.0810952 |      0.253818 |  0.0820059 |    0.257817 |
|         1161 | 1692 |    0.0907375 |      0.271134 |  0.0927896 |    0.277187 |
|         1023 | 1667 |    0.0817758 |      0.251197 |  0.0827834 |    0.254949 |
|         1092 | 1645 |    0.102263  |      0.289965 |  0.105775  |    0.29848  |
|         1038 | 1638 |    0.102108  |      0.303039 |  0.105617  |    0.313187 |


**平滑化win率が高い順（Top10）**

|   trainer_id |    n |   win_rate_s |   top3_rate_s |   win_rate |   top3_rate |
|-------------:|-----:|-------------:|--------------:|-----------:|------------:|
|         1137 | 1243 |     0.177183 |      0.407474 |   0.193886 |    0.437651 |
|         1126 |  963 |     0.17255  |      0.392937 |   0.193146 |    0.428868 |
|         1070 | 1129 |     0.155512 |      0.353638 |   0.170062 |    0.377325 |
|         1168 | 1141 |     0.147409 |      0.343017 |   0.160386 |    0.364592 |
|         1061 | 1469 |     0.144802 |      0.371471 |   0.154527 |    0.392103 |
|         1162 | 1091 |     0.13995  |      0.34081  |   0.152154 |    0.36297  |
|         1151 | 1483 |     0.130526 |      0.31134  |   0.138233 |    0.323668 |
|         1157 | 1877 |     0.128876 |      0.326907 |   0.13479  |    0.338306 |
|         1105 | 1564 |     0.122265 |      0.312917 |   0.128517 |    0.324808 |
|         1175 | 1023 |     0.119931 |      0.310699 |   0.129032 |    0.328446 |

### owner_id（件数が多いので特に上振れ注意）

**出走数が多い順（Top10）**

|   owner_id |    n |   win_rate_s |   top3_rate_s |   win_rate |   top3_rate |
|-----------:|-----:|-------------:|--------------:|-----------:|------------:|
|     415800 | 2937 |    0.0996734 |      0.280837 |  0.101464  |    0.284985 |
|     523005 | 2747 |    0.0640228 |      0.212414 |  0.0633418 |    0.211867 |
|     226800 | 2731 |    0.131585  |      0.32514  |  0.135848  |    0.332845 |
|     486800 | 2634 |    0.123386  |      0.326389 |  0.127183  |    0.334472 |
|     506800 | 2596 |    0.121486  |      0.304716 |  0.125193  |    0.311248 |
|       3060 | 2325 |    0.095317  |      0.271677 |  0.0972043 |    0.276129 |
|     546800 | 1943 |    0.0679773 |      0.229578 |  0.0674215 |    0.230571 |
|     415800 | 1941 |    0.0979334 |      0.269493 |  0.100464  |    0.274601 |
|     486800 | 1910 |    0.124965  |      0.329377 |  0.130366  |    0.340838 |
|     226800 | 1858 |    0.124235  |      0.324094 |  0.129709  |    0.335307 |


**平滑化win率が高い順（Top10）**

|   owner_id |    n |   win_rate_s |   top3_rate_s |   win_rate |   top3_rate |
|-----------:|-----:|-------------:|--------------:|-----------:|------------:|
|     195031 |  304 |     0.134276 |      0.305526 |   0.174342 |    0.361842 |
|     226800 | 2731 |     0.131585 |      0.32514  |   0.135848 |    0.332845 |
|     248030 |  334 |     0.130478 |      0.290235 |   0.164671 |    0.332335 |
|     232031 |  248 |     0.12874  |      0.32586  |   0.173387 |    0.41129  |
|     790005 |  762 |     0.125442 |      0.328467 |   0.139108 |    0.356955 |
|     500007 |  133 |     0.125151 |      0.303259 |   0.203008 |    0.428571 |
|     486800 | 1910 |     0.124965 |      0.329377 |   0.130366 |    0.340838 |
|     226800 | 1858 |     0.124235 |      0.324094 |   0.129709 |    0.335307 |
|     170800 |  737 |     0.123453 |      0.290272 |   0.137042 |    0.309362 |
|     486800 | 2634 |     0.123386 |      0.326389 |   0.127183 |    0.334472 |


**注意**

- ここでのID別勝率は **“強いIDが存在するか”の探索**には有効。

- ただしモデル入力にする場合は、リークを避けるため **時系列/交差検証でのターゲットエンコード**等が必要（学習Stepで実施）。


---

## 5. このStepの結論

- 単変量（絶対値）では `hr_rank_mean_3` 以外は弱く、競馬の難しさが出る。

- レース内相対特徴にすると、単変量でも信号が増える：

  - `hr_rank_mean_3_rank_asc` / `hr_rank_mean_3_z` / `hr_rank_mean_3_diff_mean` が上位。

- 条件系カラムは“単体で勝率を決める”より、**効き方を変える条件**として扱うのが筋。

